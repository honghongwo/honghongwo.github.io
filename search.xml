<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Hello World</title>
      <link href="/post/undefined.html"/>
      <url>/post/undefined.html</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>k8s-dns</title>
      <link href="/post/6d72aa0e.html"/>
      <url>/post/6d72aa0e.html</url>
      
        <content type="html"><![CDATA[<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><h4 id="1-1-背景"><a href="#1-1-背景" class="headerlink" title="1.1 背景"></a>1.1 背景</h4><blockquote><p>在实际生产中经常会遇到下面几个问题:<br>1.配置hosts解析，但是又不想每台服务器都加hosts配置<br>2.想用多个DNS解析不同的一级域名</p></blockquote><h4 id="1-2-解决方案"><a href="#1-2-解决方案" class="headerlink" title="1.2 解决方案"></a>1.2 解决方案</h4><blockquote><p>针对上面两个，有两种解决方案<br>1.pod 配置，针对单个pod<br>2.coreDns配置，针对集群内所有的pod</p></blockquote><h2 id="2-Pod-Dns策略配置"><a href="#2-Pod-Dns策略配置" class="headerlink" title="2.Pod Dns策略配置"></a>2.Pod Dns策略配置</h2><h4 id="2-1-pod配置文件介绍"><a href="#2-1-pod配置文件介绍" class="headerlink" title="2.1 pod配置文件介绍"></a>2.1 pod配置文件介绍</h4><blockquote><p>每个Pod所使用的DNS策略，是通过pod.spec.dnsPolicy字段设置的，共有4种DNS策略：</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ClusterFirst：默认策略，表示使用集群内部的CoreDNS来做域名解析，Pod内/etc/resolv.conf文件中配置的nameserver是集群的DNS服务器，即kube-dns的地址。</span><br><span class="line">Default：Pod直接继承集群node节点的域名解析配置，也就是，Pod会直接使用宿主机上的/etc/resolv.conf文件内容。</span><br><span class="line">None：忽略k8s集群环境中的DNS设置，Pod会使用其dnsConfig字段所提供的DNS配置，dnsConfig字段的内容要在创建Pod时手动设置好。</span><br><span class="line">ClusterFirstWithHostNet：如果Pod的hostNetwork字段设置为true，则表示Pod与宿主机共用同一个网络命名空间，此时Pod的DNS策略默认使用的是Default，不能访问集群内的服务。若希望Pod在host网络模式下还能访问集群内的服务，可以将dnsPolicy设置成ClusterFirstWithHostNet。</span><br></pre></td></tr></table></figure><h4 id="2-2-默认配置"><a href="#2-2-默认配置" class="headerlink" title="2.2 默认配置"></a>2.2 默认配置</h4><blockquote><p>将dnsPolicy字段设置为ClusterFirst，或者省略dnsPolicy字段，默认也是ClusterFirst。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx:1.7.9</span><br><span class="line">    name: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">  dnsPolicy: ClusterFirst      #该字段要设置为ClusterFirst（若省略该字段默认也是ClusterFirst）</span><br></pre></td></tr></table></figure><h4 id="2-3-自定义DNS配置"><a href="#2-3-自定义DNS配置" class="headerlink" title="2.3 自定义DNS配置"></a>2.3 自定义DNS配置</h4><blockquote><p>将dnsPolicy设置为None，同时添加dnsConfig字段手动配置DNS解析内容。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-demo</span><br><span class="line">  namespace: mytest</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx:1.7.9</span><br><span class="line">    name: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">  dnsPolicy: None</span><br><span class="line">  dnsConfig:</span><br><span class="line">    nameservers: [&quot;192.168.1.1&quot;,&quot;192.168.2.2&quot;] #最多可指定3个IP，当Pod的dnsPolicy设置为None时，列表必须至少包含一个IP地址</span><br><span class="line">    searches: #Pod中主机名查找的DNS搜索域列表</span><br><span class="line">    - default.svc.cluster.local</span><br><span class="line">    - svc.cluster.local</span><br><span class="line">    - cluster.local</span><br><span class="line">    options:</span><br><span class="line">    - name: ndots</span><br></pre></td></tr></table></figure><blockquote><p>如果dnsPolicy字段不是设置为None，而是ClusterFirst，则nameservers的地址也会加入到Pod的&#x2F;etc&#x2F;resolv.conf文件中</p></blockquote><h4 id="2-4-继承node节上的DNS配置"><a href="#2-4-继承node节上的DNS配置" class="headerlink" title="2.4 继承node节上的DNS配置"></a>2.4 继承node节上的DNS配置</h4><blockquote><p>将dnsPolicy字段设置为Default。Pod会继承宿主机上的&#x2F;etc&#x2F;resolv.conf内容，如果宿主机上&#x2F;etc&#x2F;resolv.conf文件中没有定义指向coredns地址的nameserver，则Pod容器内是无法访问到service name的。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx:1.7.9</span><br><span class="line">    name: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">  dnsPolicy: Default</span><br></pre></td></tr></table></figure><h4 id="2-5-Pod在HostNetwork网络模式下访问集群内的服务"><a href="#2-5-Pod在HostNetwork网络模式下访问集群内的服务" class="headerlink" title="2.5 Pod在HostNetwork网络模式下访问集群内的服务"></a>2.5 Pod在HostNetwork网络模式下访问集群内的服务</h4><blockquote><p>如果Pod的hostNetwork字段设置为true，也就是Pod与宿主机共享同一个网络命名空间，则此时Pod的dnsPolicy默认策略是Default，即Pod会继承宿主机上的resolv.conf文件内容。若宿主机上的resolv.conf文件中没有配置coredns地址作为域名解析服务器，则此时的Pod容器内是无法访问集群内部其他的service name的，所以要访问集群内的service name，就要将dnsPolicy字段设置为ClusterFirstWithHostNet。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx:1.7.9</span><br><span class="line">    name: nginx</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 80</span><br><span class="line">      protocol: TCP</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  dnsPolicy: ClusterFirstWithHostNet</span><br></pre></td></tr></table></figure><h2 id="3-CoreDNS策略配置"><a href="#3-CoreDNS策略配置" class="headerlink" title="3.CoreDNS策略配置"></a>3.CoreDNS策略配置</h2><h4 id="3-1-CoreDNS配置文件介绍"><a href="#3-1-CoreDNS配置文件介绍" class="headerlink" title="3.1 CoreDNS配置文件介绍"></a>3.1 CoreDNS配置文件介绍</h4><blockquote><p>获取coredns的配置项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  get configmaps coredns -n kube-system</span><br></pre></td></tr></table></figure><blockquote><p>修改coredns的配置项</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmaps coredns  -n kube-system </span><br></pre></td></tr></table></figure><blockquote><p>配置说明</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">error：错误信息到标准输出。</span><br><span class="line">health：CoreDNS自身健康状态报告，默认监听端口8080，一般用来做健康检查。可通过http://localhost:8080/health获取健康状态。</span><br><span class="line">ready：CoreDNS插件状态报告，默认监听端口8181，一般用来做可读性检查。可通过http://localhost:8181/ready读取状态。</span><br><span class="line">kubernetes：CoreDNS kubernetes插件，提供集群内服务解析能力。</span><br><span class="line">prometheus：CoreDNS自身metrics数据接口。可过http://localhost:9153/metrics获取prometheus格式的监控数据。</span><br><span class="line">forward(或proxy)：将域名查询请求转到预定义的DNS服务器。</span><br><span class="line">cache：DNS缓存。</span><br><span class="line">loop：环路检测，如果检测到环路，则停止CoreDNS。</span><br><span class="line">reload：允许自动重新加载已更改的Corefile。编辑ConfigMap配置后，最好等几分钟以使更改生效。</span><br><span class="line">loadbalance：循环负载均衡器。</span><br></pre></td></tr></table></figure><h4 id="3-2-特定域名使用指定的自定义DNS服务器"><a href="#3-2-特定域名使用指定的自定义DNS服务器" class="headerlink" title="3.2 特定域名使用指定的自定义DNS服务器"></a><strong>3.2 特定域名使用指定的自定义DNS服务器</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Corefile: |-</span><br><span class="line">  .:53 &#123;</span><br><span class="line">      errors</span><br><span class="line">      health</span><br><span class="line">      kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">         pods insecure</span><br><span class="line">         upstream</span><br><span class="line">         fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">      &#125;</span><br><span class="line">      prometheus :9153</span><br><span class="line">      proxy . /etc/resolv.conf</span><br><span class="line">      cache 30</span><br><span class="line">      loop</span><br><span class="line">      reload</span><br><span class="line">      loadbalance</span><br><span class="line">  &#125;</span><br><span class="line">  test.com:53 &#123;</span><br><span class="line">    errors</span><br><span class="line">    cache 30</span><br><span class="line">    forward . 192.168.10.100</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-3-所有外部域名都使用自建DNS服务器"><a href="#3-3-所有外部域名都使用自建DNS服务器" class="headerlink" title="3.3 所有外部域名都使用自建DNS服务器"></a>3.3 <strong>所有外部域名都使用自建DNS服务器</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Corefile: |-</span><br><span class="line">  .:53 &#123;</span><br><span class="line">      errors</span><br><span class="line">      health</span><br><span class="line">      kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">         pods insecure</span><br><span class="line">         upstream</span><br><span class="line">         fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">      &#125;</span><br><span class="line">      prometheus :9153</span><br><span class="line">      forward . 10.10.10.1 10.10.10.2     #直接指定DNS服务器IP，可以有多个</span><br><span class="line">      cache 30</span><br><span class="line">      loop</span><br><span class="line">      reload</span><br><span class="line">      loadbalance</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-4-自定义hosts"><a href="#3-4-自定义hosts" class="headerlink" title="3.4 自定义hosts"></a><strong>3.4 自定义hosts</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Corefile: |-</span><br><span class="line">  .:53 &#123;</span><br><span class="line">      errors</span><br><span class="line">      health</span><br><span class="line">      hosts &#123;     #设置hosts绑定</span><br><span class="line">        192.168.1.100 a.test.com</span><br><span class="line">        fallthrough</span><br><span class="line">      &#125;</span><br><span class="line">      kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">         pods insecure</span><br><span class="line">         upstream</span><br><span class="line">         fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">      &#125;</span><br><span class="line">      prometheus :9153</span><br><span class="line">      proxy . /etc/resolv.conf</span><br><span class="line">      cache 30</span><br><span class="line">      loop</span><br><span class="line">      reload</span><br><span class="line">      loadbalance</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>参考:<ul><li><a href="https://blog.csdn.net/qq_19676401/article/details/120505405">https://blog.csdn.net/qq_19676401&#x2F;article&#x2F;details&#x2F;120505405</a></li></ul></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> devops </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
